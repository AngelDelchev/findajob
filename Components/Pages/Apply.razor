@page "/apply/{JobId:int}"
@inject JobService JobService
@inject NavigationManager Nav
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="mt-10">
    <MudPaper Class="pa-8" Elevation="3">
        <MudText Typo="Typo.h4" GutterBottom="true">Apply for Job #@JobId</MudText>
        <EditForm Model="@_model" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <MudTextField Label="Name" @bind-Value="_model.Name" For="@(() => _model.Name)" Required="true" />
            <MudTextField Label="Email" @bind-Value="_model.Email" For="@(() => _model.Email)" Required="true" />
            <MudTextField Label="Message" @bind-Value="_model.Message" Lines="3" />
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="mt-4">Submit</MudButton>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public int JobId { get; set; } // Fixes CS1061
    private ApplicationModel _model = new(); // Fixes CS0103

    private async Task HandleSubmit()
    {
        var application = new JobApplication
        {
            JobId = JobId,
            ApplicantName = _model.Name,
            ApplicantEmail = _model.Email,
            Message = _model.Message,
            AppliedAt = DateTime.UtcNow
        };

        // Fixes CS0120 - call on the injected instance
        await JobService.SubmitApplicationAsync(application);
        
        Snackbar.Add("Application Sent!", Severity.Success);
        Nav.NavigateTo("/");
    }

    public class ApplicationModel
    {
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
    }
}
