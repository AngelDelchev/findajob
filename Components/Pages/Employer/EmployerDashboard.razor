@page "/Employer/Dashboard"
@attribute [Authorize]
@inject JobService JobService
@inject AuthenticationStateProvider AuthState
@inject NavigationManager Nav

<div class="d-flex justify-space-between align-center mb-6">
    <MudText Typo="Typo.h4" Style="color: #00f0ff; font-weight: bold;">EMPLOYER_CONTROL_PANEL</MudText>
    <MudButton Variant="Variant.Filled" 
               Color="Color.Success" 
               StartIcon="@Icons.Material.Filled.Add"
               OnClick="OpenCreateDialog">
        POST_NEW_JOB
    </MudButton>
</div>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-10">

    <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
        <MudTabPanel Text="MY_LISTINGS">
            <MudTable Items="@_myJobs" Hover="true" Dense="true">
                <HeaderContent>
                    <MudTh>TITLE</MudTh>
                    <MudTh>DATE</MudTh>
                    <MudTh>ACTIONS</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.Title</MudTd>
                    <MudTd>@context.CreatedAt.ToShortDateString()</MudTd>
                    <MudTd>
                        <MudButton Color="Color.Error" OnClick="@(() => Delete(context.Id))">TAKE_DOWN</MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>
        
        <MudTabPanel Text="APPLICATIONS">
            <MudTable Items="@_apps" Hover="true">
                <HeaderContent>
                    <MudTh>APPLICANT</MudTh>
                    <MudTh>JOB_ID</MudTh>
                    <MudTh>DATE</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd>@context.ApplicantEmail</MudTd>
                    <MudTd>@context.JobId</MudTd>
                    <MudTd>@context.AppliedAt.ToShortDateString()</MudTd>
                </RowTemplate>
            </MudTable>
        </MudTabPanel>
    </MudTabs>
</MudContainer>

@code {
    private List<JobPosting> _myJobs = new();
    private List<JobApplication> _apps = new();
    private string? _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthState.GetAuthenticationStateAsync();
        var user = authState.User;
        
        _currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (_currentUserId != null)
        {
            // FIX: Changed GetEmployerJobsAsync to GetJobsByOwnerAsync
            _myJobs = await JobService.GetJobsByOwnerAsync(_currentUserId);
            _apps = await JobService.GetApplicationsForEmployerAsync(_currentUserId);
        }
    }

    private async Task Delete(int id) 
    { 
        // FIX: Passes the required 2 arguments to the service
        await JobService.DeleteJobAsync(id, _currentUserId);
        
        // Refresh the list after deletion
        if (_currentUserId != null)
        {
            _myJobs = await JobService.GetJobsByOwnerAsync(_currentUserId);
        }
    }
    private void OpenCreateDialog()
      {
        Nav.NavigateTo("/Employer/PostJob");
      }
}
