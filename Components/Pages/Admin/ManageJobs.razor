@page "/Admin/ManageJobs"
@using findajob.Services
@using findajob.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@inject JobService JobService
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthProvider

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h3" Style="color: #00f0ff; font-weight: 900; letter-spacing: 5px;" Class="mb-6">
        DATA_ENTRY_TERMINAL
    </MudText>

    <MudGrid>
        @* FORM SECTION (Handles both Create and Edit) *@
        <MudItem xs="12" md="4">
            <MudPaper Class="pa-6" Style="background: #0a0a0a; border: 2px solid #00f0ff;">
                <EditForm Model="@_model" OnValidSubmit="HandleSave">
                    <MudText Typo="Typo.h6" Style="color: #00f0ff;" Class="mb-4">
                        @(_model.Id == 0 ? "NEW_ENTRY" : $"EDITING_ID_{_model.Id}")
                    </MudText>

                    <MudTextField @bind-Value="_model.Title" Label="JOB_TITLE" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-4" />
                    <MudTextField @bind-Value="_model.Company" Label="ORGANIZATION" Variant="Variant.Outlined" Margin="Margin.Dense" Class="mb-4" />
                    <MudTextField @bind-Value="_model.Description" Label="SPECIFICATIONS" Variant="Variant.Outlined" Lines="5" Class="mb-4" />
                    
                    <div class="d-flex gap-2">
                        <MudButton ButtonType="ButtonType.Submit" FullWidth="true" Variant="Variant.Filled" 
                                   Style="background: #00f0ff; color: black; font-weight: bold; border-radius: 0;">
                            @(_model.Id == 0 ? "UPLOAD_DATA" : "UPDATE_ENTRY")
                        </MudButton>
                        
                        @* Cancel Edit Button *@
                        @if (_model.Id != 0)
                        {
                            <MudButton OnClick="ResetForm" Variant="Variant.Outlined" Color="Color.Error">
                                CANCEL
                            </MudButton>
                        }
                    </div>
                </EditForm>
            </MudPaper>
        </MudItem>

        @* TABLE SECTION *@
        <MudItem xs="12" md="8">
            <MudTable Items="@_jobs" Hover="true" Breakpoint="Breakpoint.Sm" 
                      Style="background: #0a0a0a; border: 1px solid #333; color: white;">
                <HeaderContent>
                    <MudTh Style="color: #00f0ff;">ID</MudTh>
                    <MudTh Style="color: #00f0ff;">TITLE</MudTh>
                    <MudTh Style="color: #00f0ff;">ORG</MudTh>
                    <MudTh Style="color: #00f0ff;">ACTIONS</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.Id</MudTd>
                    <MudTd DataLabel="TITLE">@context.Title</MudTd>
                    <MudTd DataLabel="ORG">@context.Company</MudTd>
                    <MudTd>
                        @* EDIT BUTTON *@
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Warning" 
                                       OnClick="@(() => LoadJobForEdit(context.Id))" />
                        @* DELETE BUTTON *@
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" 
                                       OnClick="@(() => ConfirmDelete(context.Id))" />
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<JobPosting> _jobs = new();
    private JobPosting _model = new();
    private string? currentUserId;
    private bool _isAdmin;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        
        _isAdmin = user.IsInRole("Admin");
        currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        await LoadData();
    }

    private async Task LoadData()
    {
        if (_isAdmin)
        {
            // Monkey (Admin) sees everything
            _jobs = await JobService.GetJobsAsync();
        }
        else if (currentUserId != null)
        {
            // Regular employers only see their own
            _jobs = await JobService.GetJobsByOwnerAsync(currentUserId);
        }
    }

    private async Task LoadJobForEdit(int id)
    {
        var job = await JobService.GetJobByIdAsync(id);
        if (job != null)
        {
            _model = job;
            StateHasChanged();
        }
    }

    private void ResetForm() => _model = new JobPosting();

    private async Task HandleSave()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        if (_model.Id == 0)
        {
            _model.OwnerId = currentUserId; 
            await JobService.CreateJobAsync(_model);
            Snackbar.Add("ENTRY_CREATED", Severity.Success);
        }
        else
        {
            // Admin can edit any job; Employer only their own
            await JobService.UpdateJobAsync(_model, currentUserId, _isAdmin);
            Snackbar.Add("ENTRY_UPDATED", Severity.Success);
        }
        
        _model = new(); 
        await LoadData();
    }

    private async Task ConfirmDelete(int id)
    {
        await JobService.DeleteJobAsync(id, currentUserId, _isAdmin);
        await LoadData();
        Snackbar.Add("RECORD_DELETED", Severity.Warning);
    }
}
